# ğŸ¯ FLUJO VISUAL COMPLETO DEL CLIENTE

## Estructura del Flujo en 3 Pasos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CREAR NUEVO CLIENTE                                 â”‚
â”‚                      (Cliente + MembresÃ­a + Pago)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   PASO 1: DATOS DEL CLIENTE (Completo)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ INFO PERSONAL        â”‚  â”‚ CONTACTO         â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚âœ“ RUT/Pasaporte*      â”‚  â”‚âœ“ Email*          â”‚
        â”‚  (Validado auto)     â”‚  â”‚âœ“ Celular*        â”‚
        â”‚âœ“ Nombres*            â”‚  â”‚                  â”‚
        â”‚âœ“ Ap. Paterno*        â”‚  â”‚ EMERGENCIA       â”‚
        â”‚ Ap. Materno          â”‚  â”‚                  â”‚
        â”‚ Fecha Nacimiento     â”‚  â”‚ Nombre Contacto  â”‚
        â”‚                      â”‚  â”‚ Tel. Contacto    â”‚
        â”‚ DOMICILIO            â”‚  â”‚                  â”‚
        â”‚ DirecciÃ³n            â”‚  â”‚ OBSERVACIONES    â”‚
        â”‚                      â”‚  â”‚ Notas            â”‚
        â”‚ *= Requerido         â”‚  â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ VALIDARâ”‚ â”€â”€â–º RUT vÃ¡lido? â”€â”€â–º Formato XX.XXX.XXX-X
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   PASO 2: MEMBRESÃA E INSCRIPCIÃ“N           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SELECCIONAR          â”‚  â”‚ DESCUENTOS       â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚âœ“ MembresÃ­a*          â”‚  â”‚ Convenio         â”‚
        â”‚  (Â¿CuÃ¡l tipo?)       â”‚  â”‚ (Aplica auto)    â”‚
        â”‚âœ“ Fecha Inicio*       â”‚  â”‚                  â”‚
        â”‚  (Del formato hoy)   â”‚  â”‚ RESUMEN DINÃMICO â”‚
        â”‚                      â”‚  â”‚                  â”‚
        â”‚ *=Requerido          â”‚  â”‚ Precio Normal    â”‚
        â”‚                      â”‚  â”‚ -Descuento       â”‚
        â”‚                      â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
        â”‚                      â”‚  â”‚ = Precio Finalâœ“  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ ACTUALIZAR PRECIOS
                â”‚ FunciÃ³n:         â”‚
                â”‚ actualizarPrecio()
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   PASO 3: INFORMACIÃ“N DE PAGO               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ PAGO                 â”‚  â”‚ INFORMACIÃ“N      â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚âœ“ Monto Abonado*      â”‚  â”‚âœ“ MÃ©todo Pago*    â”‚
        â”‚                      â”‚  â”‚  (Efectivo,      â”‚
        â”‚ Sugerido: [CALC]â—„â”€â”€â”€â”€â”¼â”€â”€â”¤   Transf., etc)  â”‚
        â”‚                      â”‚  â”‚                  â”‚
        â”‚âœ“ Fecha Pago*         â”‚  â”‚âœ“ MÃ©todo Pago*    â”‚
        â”‚  (Hoy por defecto)   â”‚  â”‚  (Requerido)     â”‚
        â”‚                      â”‚  â”‚                  â”‚
        â”‚ *=Requerido          â”‚  â”‚ *=Requerido      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ DOBLE PROTECCIÃ“N â”‚
                â”‚ âœ“ Token vÃ¡lido   â”‚
                â”‚ âœ“ No duplicado   â”‚
                â”‚ âœ“ Cache 10s      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ âœ“ CLIENTE CREADO                            â”‚
        â”‚ âœ“ INSCRIPCIÃ“N REGISTRADA                    â”‚
        â”‚ âœ“ PAGO INICIAL REGISTRADO                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Validaciones y CÃ¡lculos en Tiempo Real

### 1ï¸âƒ£ PASO 1 - ValidaciÃ³n del RUT

```
ENTRADA â†’ FORMATEO AUTOMÃTICO â†’ VALIDACIÃ“N

Ejemplo 1: User escribe "78823824"
â”œâ”€ Evento: input
â”œâ”€ Formateo: "7.882.382-4"
â”œâ”€ User pierde foco: blur
â”œâ”€ API valida: âœ“ VÃ¡lido
â””â”€ Resultado: Verde + Formato correcto

Ejemplo 2: User escribe "1234567-8"
â”œâ”€ Evento: input
â”œâ”€ Formateo: "1.234.567-8"
â”œâ”€ User pierde foco: blur
â”œâ”€ API valida: âŒ InvÃ¡lido (DV incorrecto)
â””â”€ Resultado: Rojo + Mensaje error

Formato soportados:
âœ“ 78823824 â†’ 7.882.382-4
âœ“ 7.882.382-4 â†’ 7.882.382-4
âœ“ 7882382-4 â†’ 7.882.382-4
âœ“ 7.882.3824 â†’ 7.882.382-4
```

### 2ï¸âƒ£ PASO 2 - CÃ¡lculo DinÃ¡mico de Precios

```
SELECCIONAR MEMBRESÃA â†’ CONSULTAR PRECIOS â†’ APLICAR DESCUENTOS â†’ MOSTRAR TOTAL

Paso 1: User selecciona membresÃ­a
â”œâ”€ Evento: change
â”œâ”€ Llamada AJAX: GET /admin/api/precio-membresia/{id}
â””â”€ Retorna: precio_normal, precio_convenio, descuento, etc.

Paso 2: El servidor calcula
â”œâ”€ Consulta: PrecioMembresia where id_membresia = {id}
â”‚           where (fecha_vigencia_hasta IS NULL 
â”‚                  OR fecha_vigencia_hasta >= NOW())
â”œâ”€ Obtiene: $precioActual
â””â”€ Si convenio â†’ aplica precio_convenio automÃ¡ticamente

Paso 3: JavaScript actualiza DOM
â”œâ”€ precio-normal: $precioNormal
â”œâ”€ precio-descuento: $descuento (solo si > 0)
â”œâ”€ precio-final: $precioFinal â† âœ“ EL CLIENTE VE ESTO
â”œâ”€ monto-sugerido: (actualiza PASO 3)
â””â”€ precioBox: display = block (visible)

Ejemplo real:
â”œâ”€ MembresÃ­a: Clase Standard
â”œâ”€ Precio Normal: $50.000
â”œâ”€ Convenio: Gold (aplicable)
â”œâ”€ Precio Convenio: $40.000
â”œâ”€ Descuento: -$10.000
â””â”€ RESUMEN VISIBLE:
   Precio Normal: $50.000
   Descuento: -$10.000 ğŸ
   Precio Final: $40.000 âœ“
```

### 3ï¸âƒ£ PASO 3 - Monto Sugerido

```
ACTUALIZAR MONTO â†’ MOSTRAR SUGERENCIA

El monto sugerido se calcula asÃ­:
â”œâ”€ Se obtiene: precioFinal del PASO 2
â”œâ”€ Se usa como: placeholder del input monto_abonado
â”œâ”€ Se muestra como: "Sugerido: $40.000"
â””â”€ User puede cambiar si quiere pago parcial

User tiene opciones:
â”œâ”€ Acepta sugerencia: $40.000
â”œâ”€ Pago parcial: $20.000
â”œâ”€ Abona mÃ¡s: $50.000
â””â”€ Flexible segÃºn necesidad
```

---

## Protecciones Implementadas

### ğŸ”’ ProtecciÃ³n Doble EnvÃ­o (Multi-Layer)

```
NIVEL 1: FRONTEND
â”œâ”€ Token generado en formulario
â”œâ”€ BotÃ³n deshabilitado mientras procesa
â””â”€ Spinner visible

NIVEL 2: SERVIDOR (Cache)
â”œâ”€ Token validado: Cache::has(key)?
â”œâ”€ Si NO existe â†’ Procesar
â”œâ”€ Si SÃ existe â†’ ERROR "EnvÃ­o duplicado"
â””â”€ Token vÃ¡lido por 10 segundos

NIVEL 3: VALIDACIÃ“N
â”œâ”€ Todos los datos validados
â”œâ”€ Errores retornados si fallan
â””â”€ TransacciÃ³n atÃ³mica
```

---

## Problemas Resueltos

### âŒ ANTES (Problemas)

```
1. RUT no se formateaba automÃ¡ticamente
   â””â”€ User escribÃ­a: 78823824
   â””â”€ No habÃ­a transformaciÃ³n a 7.882.382-4

2. Campos faltantes
   â””â”€ No se capturaba: emergencia, domicilio, etc.
   â””â”€ Flujo incompleto

3. Precios mal calculados
   â””â”€ Consulta SQL con whereNull mal agrupado
   â””â”€ PodrÃ­a devolver membresÃ­a incorrecta

4. Totales no visibles
   â””â”€ Resumen de precios no mostraba bien
   â””â”€ Descuentos no se calculaban
```

### âœ… AHORA (Solucionado)

```
1. RUT formateado automÃ¡ticamente
   âœ“ User escribe: 78823824
   âœ“ Muestra: 7.882.382-4 (automÃ¡tico)
   âœ“ Validado en servidor

2. Campos completos
   âœ“ Se capturan: emergencia, domicilio, observaciones
   âœ“ Flujo completo y profesional

3. Precios correctos
   âœ“ Consulta SQL agrupada correctamente
   âœ“ Siempre obtiene la membresÃ­a correcta

4. Totales visibles
   âœ“ SecciÃ³n "Resumen de Precios" funcional
   âœ“ Descuentos se calculan dinÃ¡micamente
   âœ“ Monto sugerido actualizado automÃ¡ticamente
```

---

## ğŸ§ª Casos de Prueba

### TEST 1: Crear Cliente con RUT
```
Input: "78823824"
âœ“ Se formatea a: 7.882.382-4
âœ“ Se valida en servidor
âœ“ Guardarse con formato correcto
```

### TEST 2: Crear Cliente con MembresÃ­a
```
1. Crear cliente â†’ Paso 1 âœ“
2. Ir Paso 2
3. Seleccionar membresÃ­a
4. VERIFICAR:
   âœ“ Aparece "Resumen de Precios"
   âœ“ Muestra "Precio Normal: $XX.XXX"
   âœ“ Muestra "Precio Final: $XX.XXX"
5. Seleccionar convenio
6. VERIFICAR:
   âœ“ Aparece "Descuento: -$X.XXX"
   âœ“ "Precio Final" se actualiza
```

### TEST 3: Crear Cliente Completo
```
1. Paso 1: Llenar TODOS los datos
   âœ“ Datos personales
   âœ“ Contacto
   âœ“ Emergencia (opcional)
   âœ“ Domicilio (opcional)
   âœ“ Observaciones (opcional)

2. Paso 2: Seleccionar membresÃ­a y convenio
   âœ“ Ver cÃ¡lculo de precios

3. Paso 3: Ingresar pago
   âœ“ Ver monto sugerido
   âœ“ Guardar

4. VERIFICAR:
   âœ“ Cliente creado
   âœ“ InscripciÃ³n creada
   âœ“ Pago registrado
```

---

## ğŸ“ Soporte

Si encuentras problemas:

1. **RUT no se formatea**
   - Verifica que tengas JavaScript habilitado
   - Mira la consola (F12) para errores
   - AsegÃºrate de perder el foco del campo (tab o click)

2. **Precios no se actualizan**
   - Verifica que selecciones una membresÃ­a
   - Mira la consola para errores de fetch
   - Revisa que el precio estÃ© en la BD

3. **No puedo guardar**
   - Verifica que todos los campos requeridos (*) estÃ©n llenos
   - Espera a que el botÃ³n "Guardar" estÃ© habilitado
   - Mira los mensajes de error en rojo

